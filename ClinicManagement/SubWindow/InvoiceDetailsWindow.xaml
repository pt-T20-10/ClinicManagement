<Window x:Class="ClinicManagement.SubWindow.InvoiceDetailsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ClinicManagement.SubWindow"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="13"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
           xmlns:uc="clr-namespace:ClinicManagement.UserControlToUse"
                xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        mc:Ignorable="d"
         WindowStyle="None"
         ResizeMode="NoResize"
         Height="1000" Width="950"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0">
            <uc:ControlBarUC ></uc:ControlBarUC>
        </Grid>
        <Grid Margin="20" Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <!-- Row 1: Invoice Information -->
                <RowDefinition Height="*" />
                <!-- Row 2: Invoice Details DataGrid -->
                <RowDefinition Height="Auto" />
                <!-- Row 3: Totals, Discounts, Taxes -->
            </Grid.RowDefinitions>

            <!-- ROW 1: INVOICE INFORMATION -->
            <materialDesign:Card Grid.Row="0" Margin="0,0,0,16" Padding="16" UniformCornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Left side: Invoice details -->
                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Title -->
                        <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,0,0,16">
                            <materialDesign:PackIcon Kind="ReceiptText" Width="32" Height="32" VerticalAlignment="Center"/>
                            <TextBlock Text="THÔNG TIN HÓA ĐƠN" FontSize="24" FontWeight="Medium" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Invoice Information Column 1 -->
                        <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,24,0">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Mã hóa đơn:" FontWeight="SemiBold" Width="120"/>
                                <TextBlock Text="{Binding Invoice.InvoiceId}" Foreground="#1976D2" FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Loại hóa đơn:" FontWeight="SemiBold" Width="120"/>
                                <TextBlock Text="{Binding Invoice.InvoiceType}"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Ngày lập:" FontWeight="SemiBold" Width="120"/>
                                <TextBlock Text="{Binding Invoice.InvoiceDate, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Trạng thái:" FontWeight="SemiBold" Width="120"/>
                                <TextBlock Text="{Binding Invoice.Status}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Invoice.Status}" Value="Đã thanh toán">
                                                    <Setter Property="Foreground" Value="#2E7D32"/>
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Invoice.Status}" Value="Chưa thanh toán">
                                                    <Setter Property="Foreground" Value="#EF6C00"/>
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </StackPanel>

                        <!-- Invoice Information Column 2 (Patient Info if available) -->
                        <StackPanel Grid.Row="1" Grid.Column="1" Visibility="{Binding HasPatient, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="THÔNG TIN KHÁCH HÀNG" FontWeight="Medium" FontSize="16" Margin="0,0,0,8"/>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Họ tên:" FontWeight="SemiBold" Width="100"/>
                                <TextBlock Text="{Binding Invoice.Patient.FullName}"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Số điện thoại:" FontWeight="SemiBold" Width="100"/>
                                <TextBlock Text="{Binding Invoice.Patient.Phone}"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Mã BHYT:" FontWeight="SemiBold" Width="100"/>
                                <TextBlock Text="{Binding Invoice.Patient.InsuranceCode}"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Notes for the invoice -->
                        <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Margin="0,8,0,0">
                            <TextBlock Text="Ghi chú:" FontWeight="SemiBold"/>
                            <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,4,0,0">
                                <TextBlock Text="{Binding Invoice.Notes}" TextWrapping="Wrap" 
                                   Foreground="#555555"
                                   MinHeight="40"/>
                            </Border>
                        </StackPanel>
                    </Grid>

                    <!-- Right side: Controls -->

                </Grid>
            </materialDesign:Card>

            <!-- ROW 2: INVOICE DETAILS TABLE AND MEDICAL ADVICE (IF APPLICABLE) -->
            <Grid Grid.Row="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Invoice Details DataGrid -->
                <materialDesign:Card Grid.Row="0" Margin="0,0,0,16" UniformCornerRadius="4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- Title -->
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="16,16,16,8">
                            <materialDesign:PackIcon Kind="ClipboardListOutline" Width="24" Height="24" VerticalAlignment="Center"/>
                            <TextBlock Text="CHI TIẾT HÓA ĐƠN" FontSize="18" FontWeight="Medium" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- DataGrid -->
                        <DataGrid 
                    Grid.Row="1"
                    ItemsSource="{Binding InvoiceDetails}" 
                    AutoGenerateColumns="False"
                    IsReadOnly="True"
                    CanUserSortColumns="True"
                    CanUserResizeColumns="True"
                    HeadersVisibility="Column"
                    BorderThickness="0"
                    RowHeight="40"
                    Margin="8,0,8,8">
                            <DataGrid.Columns>
                                <!-- STT -->
                                <DataGridTemplateColumn Header="#" Width="40">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type DataGridRow}}, Path=GetIndex}" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Tên thuốc/dịch vụ -->
                                <DataGridTextColumn Header="Tên thuốc/dịch vụ" Binding="{Binding Medicine.Name}" Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="TextWrapping" Value="Wrap"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Đơn vị -->
                                <DataGridTextColumn Header="Đơn vị" Binding="{Binding Medicine.Unit.Name}" Width="80">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Số lượng -->
                                <DataGridTextColumn Header="Số lượng" Binding="{Binding Quantity}" Width="80">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Đơn giá -->
                                <DataGridTextColumn Header="Đơn giá" Binding="{Binding SalePrice, StringFormat='{}{0:N0} VNĐ'}" Width="120">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Giảm giá % -->
                                <DataGridTextColumn Header="Giảm giá" Binding="{Binding Discount, StringFormat='{}{0:N1}%'}" Width="80">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Thành tiền -->
                                <DataGridTemplateColumn Header="Thành tiền" Width="130">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding LineTotal, StringFormat='{}{0:N0} VNĐ'}" 
                                               HorizontalAlignment="Right" 
                                               VerticalAlignment="Center"
                                               FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>

                            <DataGrid.Resources>
                                <Style TargetType="DataGridRow">
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F5F5F5"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#E3F2FD"/>
                                            <Setter Property="Foreground" Value="#1565C0"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="#ECEFF1"/>
                                    <Setter Property="Foreground" Value="#37474F"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Height" Value="40"/>
                                    <Setter Property="Padding" Value="8,0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                </Style>
                            </DataGrid.Resources>
                        </DataGrid>
                    </Grid>
                </materialDesign:Card>

                <!-- Medical Record & Doctor's Advice (If applicable) -->
                <materialDesign:Card Grid.Row="1" Margin="0,0,0,16" Padding="16" UniformCornerRadius="4"
                             Visibility="{Binding HasMedicalRecord, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <materialDesign:PackIcon Kind="NoteTextOutline" Width="24" Height="24" VerticalAlignment="Center"/>
                            <TextBlock Text="HỒ SƠ KHÁM BỆNH VÀ LỜI DẶN" FontSize="18" FontWeight="Medium" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Diagnose Information -->
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="CHẨN ĐOÁN" FontWeight="Medium" Margin="0,0,0,4"/>
                                <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8">
                                    <TextBlock Text="{Binding MedicalRecord.Diagnosis}" TextWrapping="Wrap" MinHeight="60"/>
                                </Border>

                                <TextBlock Text="TRIỆU CHỨNG" FontWeight="Medium" Margin="0,0,0,4"/>
                                <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8">
                                    <TextBlock Text="{Binding MedicalRecord.Symptoms}" TextWrapping="Wrap" MinHeight="60"/>
                                </Border>
                            </StackPanel>

                            <!-- Doctor's Advice -->
                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="LỜI DẶN CỦA BÁC SĨ" FontWeight="Medium" Margin="0,0,0,4"/>
                                <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8">
                                    <TextBlock Text="{Binding MedicalRecord.DoctorNotes}" TextWrapping="Wrap" MinHeight="60"/>
                                </Border>

                                <TextBlock Text="BÁC SĨ KHÁM" FontWeight="Medium" Margin="0,0,0,4"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Width="80" Height="80" BorderBrush="#DDDDDD" BorderThickness="1" Margin="0,0,8,0">
                                        <Image Source="{Binding MedicalRecord.Doctor.ImagePath}" Stretch="Uniform"/>
                                    </Border>

                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding MedicalRecord.Doctor.FullName}" FontWeight="SemiBold" FontSize="14"/>
                                        <TextBlock Text="{Binding MedicalRecord.Doctor.Specialty}" FontStyle="Italic" Margin="0,4,0,0"/>
                                        <TextBlock Text="{Binding MedicalRecord.RecordDate, StringFormat='Ngày khám: {0:dd/MM/yyyy}'}" Margin="0,4,0,0"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>

            <!-- ROW 3: TOTALS, DISCOUNTS, TAXES -->
            <materialDesign:Card Grid.Row="2" Padding="16" UniformCornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="280"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Payment method info -->
                    <StackPanel Grid.Column="0" Visibility="{Binding IsPaid, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="THÔNG TIN THANH TOÁN" FontWeight="Medium" Margin="0,0,0,8"/>

                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Phương thức thanh toán:" Width="160"/>
                            <TextBlock Text="{Binding PaymentMethod}" FontWeight="SemiBold"/>
                        </StackPanel>
                    </StackPanel>
                    <StackPanel Grid.Row="1"   VerticalAlignment="Bottom" Grid.RowSpan="2" Orientation="Horizontal" Margin="16,0,0,0">
                        <Button
                  Command="{Binding CloseWindow}"
                  Style="{StaticResource MaterialDesignOutlinedButton}"
                  Margin="10,0,40,0" Width="150" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="ExitToApp" Margin="0,0,8,0"/>
                                <TextBlock Text="Đóng"/>
                            </StackPanel>
                        </Button>
                        <Button
            Command="{Binding PrintInvoiceCommand}"
            Style="{StaticResource MaterialDesignOutlinedButton}"
            Margin="10,0,40,0" Width="150" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Printer" Margin="0,0,8,0"/>
                                <TextBlock Text="In hóa đơn"/>
                            </StackPanel>
                        </Button>

                        <!-- Conditionally show Pay button -->
                        <Button
            Command="{Binding ProcessPaymentCommand}"
     
            Width="140" Height="40"
            Background="#4CAF50"
            BorderBrush="#388E3C">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Invoice.Status}" Value="Đã thanh toán">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="CreditCardOutline" Margin="0,0,8,0"/>
                                <TextBlock Text="Thanh toán"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Total calculations -->
                    <Grid Grid.Column="1" HorizontalAlignment="Right">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>

                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="140"/>
                        </Grid.ColumnDefinitions>

                        <!-- Subtotal -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Tạm tính:" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,0,16,8"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SubTotal, StringFormat='{}{0:N0} VNĐ'}" HorizontalAlignment="Right" Margin="0,0,0,8"/>

                        <!-- Discount -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Giảm giá:" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,0,16,8"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" 
                           Text="{Binding TotalDiscount, StringFormat='{}{0:N0} VNĐ'}" 
                           Foreground="#1B5E20" 
                           HorizontalAlignment="Right" 
                           Margin="0,0,0,8"/>

                        <!-- Tax -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Thuế VAT (10%):" FontWeight="Medium" HorizontalAlignment="Right" Margin="0,0,16,8"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TaxAmount, StringFormat='{}{0:N0} VNĐ'}" HorizontalAlignment="Right" Margin="0,0,0,8"/>

                        <!-- Divider -->
                        <Border Grid.Row="3" Grid.ColumnSpan="2" BorderBrush="#DDDDDD" BorderThickness="0,1,0,0" Margin="0,4,0,8"/>

                        <!-- Total -->
                        <TextBlock Grid.Row="4" Grid.Column="0" Text="TỔNG CỘNG:" FontWeight="Bold" FontSize="16" HorizontalAlignment="Right" Margin="0,0,16,0"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" 
                           Text="{Binding Invoice.TotalAmount, StringFormat='{}{0:N0} VNĐ'}" 
                           FontWeight="Bold" 
                           FontSize="16" 
                           Foreground="#C62828" 
                           HorizontalAlignment="Right"/>


                    </Grid>
                </Grid>
            </materialDesign:Card>
        </Grid>
    </Grid>
    
</Window>
